<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>babyLLM - AI Search Assistant</title>
    <meta name="description" content="AI-powered search assistant with intelligent summaries and conversational interface">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="babyLLM">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="silicon-valley-styles.css" as="style">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z'/%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="silicon-valley-styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                            <path d="M19 11L19.74 13.09L22 14L19.74 14.91L19 17L18.26 14.91L16 14L18.26 13.09L19 11Z" fill="currentColor"/>
                            <path d="M5 11L5.74 13.09L8 14L5.74 14.91L5 17L4.26 14.91L2 14L4.26 13.09L5 11Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="logo-text">babyLLM</div>
                </div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <span class="new-chat-btn-text">New Search</span>
                </button>
            </div>
            
            <div class="chat-history" id="chatHistory">
                <div class="history-item active" onclick="loadChat('current')">
                    <div>Current Search Session</div>
                    <small>Just now</small>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-menu" onclick="showUserMenu()">
                    <div class="user-avatar">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: #ffffff; font-weight: 500;">Demo User</div>
                        <div style="font-size: 12px; color: #a0a0a0;">Free Plan</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title">AI Search Assistant</div>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">Welcome to babyLLM</h1>
                    <p class="welcome-subtitle">
                        Your AI-powered search assistant. Ask me anything and I'll provide comprehensive answers with sources.
                    </p>
                    
                    <div class="example-prompts">
                        <div class="example-prompt" onclick="sendExampleQuery('What is artificial intelligence and how does it work?')">
                            <div class="example-prompt-title">Explain Artificial Intelligence</div>
                            <div class="example-prompt-desc">Learn about AI fundamentals, machine learning, and real-world applications</div>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleQuery('Latest developments in quantum computing')">
                            <div class="example-prompt-title">Quantum Computing Research</div>
                            <div class="example-prompt-desc">Discover cutting-edge quantum technologies and recent breakthroughs</div>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleQuery('Best practices for modern web development')">
                            <div class="example-prompt-title">Web Development Guide</div>
                            <div class="example-prompt-desc">Explore modern frameworks, tools, and development methodologies</div>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleQuery('How to start a career in data science?')">
                            <div class="example-prompt-title">Data Science Career Path</div>
                            <div class="example-prompt-desc">Get comprehensive guidance on skills, tools, and career opportunities</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Ask me anything..."
                        rows="1"
                        onkeydown="handleInputKeydown(event)"
                        oninput="adjustTextareaHeight()"
                    ></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let conversationHistory = [];
        let isTyping = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            checkBackendStatus();
            setInterval(checkBackendStatus, 30000);
            adjustTextareaHeight();
        });

        // Backend status check
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                updateStatus(true, 'Connected');
            } catch (error) {
                updateStatus(false, 'Disconnected');
            }
        }

        function updateStatus(connected, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = connected ? 'status-dot' : 'status-dot disconnected';
            statusText.textContent = text;
        }

        // Chat functionality
        function startNewChat() {
            conversationHistory = [];
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">Welcome to babyLLM</h1>
                    <p class="welcome-subtitle">
                        Your AI-powered search assistant. Ask me anything and I'll provide comprehensive answers with sources.
                    </p>
                    
                    <div class="example-prompts">
                        <div class="example-prompt" onclick="sendExampleQuery('What is artificial intelligence and how does it work?')">
                            <div class="example-prompt-title">Explain Artificial Intelligence</div>
                            <div class="example-prompt-desc">Learn about AI fundamentals, machine learning, and real-world applications</div>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleQuery('Latest developments in quantum computing')">
                            <div class="example-prompt-title">Quantum Computing Research</div>
                            <div class="example-prompt-desc">Discover cutting-edge quantum technologies and recent breakthroughs</div>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleQuery('Best practices for modern web development')">
                            <div class="example-prompt-title">Web Development Guide</div>
                            <div class="example-prompt-desc">Explore modern frameworks, tools, and development methodologies</div>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleQuery('How to start a career in data science?')">
                            <div class="example-prompt-title">Data Science Career Path</div>
                            <div class="example-prompt-desc">Get comprehensive guidance on skills, tools, and career opportunities</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('chatInput').value = '';
        }

        function sendExampleQuery(query) {
            document.getElementById('chatInput').value = query;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // Hide welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            adjustTextareaHeight();
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Search for information
                const searchResponse = await fetch(`${API_URL}/api/search?q=${encodeURIComponent(message)}`);
                const searchData = await searchResponse.json();
                
                if (searchData.success) {
                    // Generate AI response with search results
                    const aiResponse = generateAIResponse(message, searchData);
                    
                    // Remove typing indicator and add AI response
                    removeTypingIndicator();
                    addMessage('assistant', aiResponse, searchData.results);
                    
                    // Add to conversation history
                    conversationHistory.push({
                        user: message,
                        assistant: aiResponse,
                        timestamp: new Date(),
                        results: searchData.results
                    });
                    
                    // Update chat history in sidebar
                    updateChatHistory();
                } else {
                    throw new Error(searchData.message || 'Search failed');
                }
            } catch (error) {
                removeTypingIndicator();
                addMessage('assistant', `I apologize, but I encountered an error while searching: ${error.message}. Please try again.`);
            }
        }

        function generateAIResponse(query, searchData) {
            const responses = [
                `Based on my comprehensive search, here's what I found about "${query}":`,
                `I've analyzed multiple sources and gathered detailed information about "${query}":`,
                `Here's a thorough overview of "${query}" based on current authoritative sources:`,
                `Let me break down the comprehensive information I discovered about "${query}":`
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            const summary = `${randomResponse}\n\nI found ${searchData.results.length} highly relevant sources that provide comprehensive coverage of this topic. The search results include detailed information from various authoritative sources. You can explore each result below for more specific insights and analysis.`;
            
            return summary;
        }

        function addMessage(type, content, results = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = type === 'user' ? 
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>` : 
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    <path d="M19 11L19.74 13.09L22 14L19.74 14.91L19 17L18.26 14.91L16 14L18.26 13.09L19 11Z" fill="currentColor"/>
                    <path d="M5 11L5.74 13.09L8 14L5.74 14.91L5 17L4.26 14.91L2 14L4.26 13.09L5 11Z" fill="currentColor"/>
                </svg>`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let resultsHTML = '';
            if (results && results.length > 0) {
                resultsHTML = `
                    <div class="search-results">
                        ${results.map((result, index) => `
                            <div class="search-result-item">
                                <a href="${result.url}" target="_blank" class="result-title">${result.title}</a>
                                <div class="result-url">${new URL(result.url).hostname}</div>
                                <div class="result-snippet">${result.snippet}</div>
                                <div class="result-actions">
                                    <button class="result-action-btn" onclick="generateSummary('${result.url}', ${index})">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Summarize
                                    </button>
                                    <button class="result-action-btn" onclick="window.open('${result.url}', '_blank')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 13V19C18 19.5304 17.7893 20.0391 17.4142 20.4142C17.0391 20.7893 16.5304 21 16 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V8C3 7.46957 3.21071 6.96086 3.58579 6.58579C3.96086 6.21071 4.46957 6 5 6H11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M15 3H21V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M10 14L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Visit
                                    </button>
                                    <button class="result-action-btn" onclick="askFollowUp('${result.title}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Ask more
                                    </button>
                                </div>
                                <div id="summary-${index}" style="display: none;"></div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${content.replace(/\n/g, '<br>')}
                        ${resultsHTML}
                    </div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            isTyping = true;
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                        <path d="M19 11L19.74 13.09L22 14L19.74 14.91L19 17L18.26 14.91L16 14L18.26 13.09L19 11Z" fill="currentColor"/>
                        <path d="M5 11L5.74 13.09L8 14L5.74 14.91L5 17L4.26 14.91L2 14L4.26 13.09L5 11Z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function generateSummary(url, index) {
            const summaryContainer = document.getElementById(`summary-${index}`);
            summaryContainer.style.display = 'block';
            summaryContainer.innerHTML = '<div style="padding: 16px; font-style: italic; color: #6b7280;">AI is generating comprehensive summary...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/summary/webpage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    summaryContainer.innerHTML = `
                        <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); padding: 20px; border-radius: 12px; margin-top: 16px; border-left: 4px solid #6366f1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                            <div style="font-weight: 600; color: #6366f1; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                                </svg>
                                AI Summary
                            </div>
                            <div style="color: #374151; line-height: 1.6; font-size: 15px;">${data.data.summary}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 12px; font-style: italic;">
                                Generated at ${new Date(data.data.processedAt).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Failed to generate summary');
                }
            } catch (error) {
                summaryContainer.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fee 0%, #fecaca 100%); padding: 16px; border-radius: 12px; margin-top: 16px; color: #dc2626; border-left: 4px solid #ef4444;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
                                <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            Failed to generate summary: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        function askFollowUp(title) {
            const followUpQuery = `Tell me more about: ${title}`;
            document.getElementById('chatInput').value = followUpQuery;
            document.getElementById('chatInput').focus();
        }

        function updateChatHistory() {
            const historyContainer = document.getElementById('chatHistory');
            const currentTime = new Date();
            
            // Add new history item
            if (conversationHistory.length > 0) {
                const lastConversation = conversationHistory[conversationHistory.length - 1];
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>${lastConversation.user.substring(0, 35)}${lastConversation.user.length > 35 ? '...' : ''}</div>
                    <small>${getTimeAgo(lastConversation.timestamp)}</small>
                `;
                historyContainer.appendChild(historyItem);
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return timestamp.toLocaleDateString();
        }

        // Input handling
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // User menu
        function showUserMenu() {
            alert('User menu - Login/Signup functionality available');
        }

        // Enhanced mobile sidebar management
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }
        
        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scroll
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore scroll
        }
        
        // Close sidebar on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSidebar();
            }
        });
        
        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('chatInput').focus();
            }
            
            // Ctrl/Cmd + N for new chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                startNewChat();
            }
            
            // Ctrl/Cmd + M to toggle sidebar on desktop
            if ((e.ctrlKey || e.metaKey) && e.key === 'm' && window.innerWidth > 768) {
                e.preventDefault();
                toggleSidebar();
            }
        });

        // Add mobile menu button and initialize responsive behavior
        function initializeResponsiveUI() {
            const header = document.querySelector('.chat-header');
            
            // Only add menu button if it doesn't exist and we're on mobile
            if (window.innerWidth <= 768 && !document.getElementById('mobileMenuBtn')) {
                const menuButton = document.createElement('button');
                menuButton.id = 'mobileMenuBtn';
                menuButton.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="3" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="3" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `;
                menuButton.style.cssText = 'background: none; border: none; cursor: pointer; color: #374151; padding: 8px; border-radius: 6px; transition: background-color 0.15s;';
                menuButton.onmouseover = () => menuButton.style.backgroundColor = 'rgba(0,0,0,0.05)';
                menuButton.onmouseout = () => menuButton.style.backgroundColor = 'transparent';
                menuButton.onclick = toggleSidebar;
                header.insertBefore(menuButton, header.firstChild);
            } else if (window.innerWidth > 768) {
                // Remove mobile menu button on desktop
                const mobileBtn = document.getElementById('mobileMenuBtn');
                if (mobileBtn) {
                    mobileBtn.remove();
                }
                // Ensure sidebar is closed on desktop resize
                closeSidebar();
            }
        }
        
        // Initialize responsive UI
        initializeResponsiveUI();
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                initializeResponsiveUI();
            }, 150);
        });
        
        // Performance optimization: Debounced scroll handler
        let scrollTimeout;
        document.getElementById('chatMessages').addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                // Add any scroll-based optimizations here
            }, 100);
        });
        
        // Auto-resize textarea with better performance
        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';
            // Set height based on content, with min and max constraints
            const newHeight = Math.min(Math.max(textarea.scrollHeight, 56), 200);
            textarea.style.height = newHeight + 'px';
        }
        
        // Enhanced input handling with better UX
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            } else if (event.key === 'Escape') {
                event.target.blur();
            }
        }
        
        // Add loading states to buttons
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.classList.add('loading');
                const originalContent = button.innerHTML;
                button.dataset.originalContent = originalContent;
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.3"/>
                        <path d="M12 2C6.48 2 2 6.48 2 12" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <animateTransform attributeName="transform" type="rotate" values="0 12 12;360 12 12" dur="1s" repeatCount="indefinite"/>
                        </path>
                    </svg>
                `;
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                if (button.dataset.originalContent) {
                    button.innerHTML = button.dataset.originalContent;
                }
            }
        }
    </script>
</body>
</html>
